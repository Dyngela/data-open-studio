<div class="flex flex-col h-screen w-full bg-jb-dark text-jb-text select-none playground-container">

  <div class="flex grow overflow-hidden">

    <aside class="w-7.5 flex flex-col bg-jb-header border-r border-jb-border">
      @for (tab of layoutService.leftTabs(); track tab.label) {
        <div (click)="layoutService.toggleSidebar(tab.label, tab.position)"
             class="group relative py-4 flex flex-col items-center cursor-pointer transition-colors"
             [class.bg-jb-dark]="tab.active"
             [class.hover:bg-jb-hover]="!tab.active">

          @if (tab.active) {
            <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-jb-accent"></div>
          }

          <span class="text-sm mb-2" [class.text-white]="tab.active">{{ tab.icon }}</span>
          <span class="text-[10px] uppercase font-bold tracking-tighter"
                style="writing-mode: vertical-rl; transform: rotate(180deg);"
                [class.text-white]="tab.active">
            {{ tab.label }}
          </span>
        </div>
      }
    </aside>

    @if (layoutService.isAnySidePanelOpen()) {
      <div [style.width.px]="layoutService.sidebarWidth()" class="bg-jb-header flex flex-col overflow-hidden">
        <div class="p-2 text-[11px] font-bold uppercase opacity-80 flex justify-between">
          <span>{{layoutService.selectedTab()?.label}}</span>
          <span class="hover:text-white cursor-pointer" (click)="layoutService.toggleSidebar('reset', 'left')">âœ•</span>
        </div>
        @switch (layoutService.selectedTab()?.label) {
          @case ('Nodes') {
            <app-node-panel />
          }

          @default {
            <div class="p-4 text-center text-jb-text/50">
              No panel available
            </div>
          }
        }
      </div>

      <div (mousedown)="layoutService.startResizing($event)"
           class="w-0.75 h-full cursor-col-resize hover:bg-jb-accent/50 active:bg-jb-accent transition-colors z-50">
      </div>
    }

    <main class="grow flex flex-col min-w-0">
      <div class="main-area">
        <div
          #playgroundArea
          class="playground-area"
          cdkDropList
          id="playground-area"
          [cdkDropListConnectedTo]="['node-panel-list']"
          (cdkDropListDropped)="onDrop($event)"
          (mousedown)="onPlaygroundMouseDown($event)"
          (mousemove)="onPlaygroundMouseMove($event)"
          (mouseup)="onPlaygroundMouseUp($event)"
          (click)="onPlaygroundClick($event)"
          (wheel)="onWheel($event)"
          (contextmenu)="onPlaygroundContextMenu($event)"
          [class.panning]="isPanning()"
          [style.--zoom]="zoom()"
          [style.--pan-x]="panOffset().x"
          [style.--pan-y]="panOffset().y"
        >

          <div class="canvas" [style.transform]="canvasTransform()">
            <svg class="connections-layer">
              @for (connection of connections(); track $index) {
                <!-- Invisible wide hit area for easier clicking -->
                <path
                  [attr.d]="connectionPathStrings()[$index]"
                  fill="none"
                  stroke="transparent"
                  stroke-width="14"
                  class="connection-hit-area"
                  (click)="onConnectionClick($event, connection)"
                  (contextmenu)="onConnectionContextMenu($event, connection)"
                />
                <path
                  [attr.d]="connectionPathStrings()[$index]"
                  [class]="'connection connection-' + nodeGraph.getConnectionKind(connection) + (isConnectionSelected(connection) ? ' connection-selected' : '')"
                  fill="none"
                  [attr.stroke]="isConnectionSelected(connection) ? '#FF9800' : (nodeGraph.getConnectionKind(connection) === 'data' ? '#2196F3' : '#4CAF50')"
                  [attr.stroke-width]="isConnectionSelected(connection) ? 4 : 3"
                  (click)="onConnectionClick($event, connection)"
                  (contextmenu)="onConnectionContextMenu($event, connection)"
                />
              }

              @if (tempConnection(); as temp) {
                <path
                  [attr.d]="nodeGraph.getTempConnectionPath(temp)"
                  class="temp-connection"
                  fill="none"
                  stroke="#FF9800"
                  stroke-width="3"
                  stroke-dasharray="5,5"
                />
              }
            </svg>

            @for (node of nodes(); track node.id) {
              <div
                class="node-wrapper"
                [class.node-selected]="selectedNodeId() === node.id"
                [style.transform]="'translate(' + node.position.x + 'px, ' + node.position.y + 'px)'"
                (mousedown)="onNodeMouseDown($event, node.id)"
                (click)="$event.stopPropagation()"
                (dblclick)="layoutService.openNodeModal(node.id)"
                (contextmenu)="onNodeContextMenu($event, node.id)"
              >
                <app-node-instance
                  [node]="node"
                  [isPanning]="isPanning()"
                  (outputPortClick)="onOutputPortClick($event)"
                  (inputPortClick)="onInputPortClick($event)"
                ></app-node-instance>
              </div>
            }
          </div>

          @if (isLoadingJob()) {
            <div class="loading-overlay">
              <i class="pi pi-spin pi-spinner"></i>
              <span>Chargement du job...</span>
            </div>
          }

          @if (layoutService.activeModal(); as modal) {
            <div class="modal-overlay">
              <div class="modal-container">
                @if (modal.nodeTypeId === 'db-input' && nodeGraph.getNodeById(modal.nodeId); as node) {
                  <app-db-input-modal
                    [node]="node"
                  ></app-db-input-modal>
                }
                @if (modal.nodeTypeId === 'start' && nodeGraph.getNodeById(modal.nodeId); as node) {
                  <app-start-modal
                  ></app-start-modal>
                }
                @if (modal.nodeTypeId === 'transform' && nodeGraph.getNodeById(modal.nodeId); as node) {
                  <app-transform-modal
                    [node]="node"
                  ></app-transform-modal>
                }
                @if (modal.nodeTypeId === 'log' && nodeGraph.getNodeById(modal.nodeId); as node) {
                  <app-log-modal
                    [node]="node"
                  ></app-log-modal>
                }
              </div>
            </div>
          }

          <app-minimap
            [nodes]="nodes()"
            [viewportWidth]="layoutService.viewportWidth()"
            [viewportHeight]="layoutService.viewportHeight()"
            [panOffset]="panOffset()"
            [zoom]="zoom()"
          ></app-minimap>

          <p-contextMenu #contextMenu [model]="contextMenuItems()" appendTo="body" />

          @if (isRenaming()) {
            <div class="rename-overlay" (click)="cancelRename()">
              <div
                class="rename-dialog"
                [style.left.px]="renamePosition().x"
                [style.top.px]="renamePosition().y"
                (click)="$event.stopPropagation()"
              >
                <label class="rename-label">Rename node</label>
                <input
                  class="rename-input"
                  [ngModel]="renameValue()"
                  (ngModelChange)="renameValue.set($event)"
                  (keydown.enter)="confirmRename()"
                  (keydown.escape)="cancelRename()"
                  autofocus
                />
                <div class="rename-actions">
                  <button class="rename-btn rename-btn-cancel" (click)="cancelRename()">Cancel</button>
                  <button class="rename-btn rename-btn-confirm" (click)="confirmRename()">Rename</button>
                </div>
              </div>
            </div>
          }
        </div>

        @if (layoutService.IsBottomPanelOpen()) {
          <app-playground-bottom-bar
            #bottomBar
            [job]="currentJob()"
            (onSave)="onJobSave()"
            (onExecute)="onJobExecute()"
            (onStop)="onJobStop()"
          ></app-playground-bottom-bar>
        }
      </div>

    </main>
  </div>
</div>
