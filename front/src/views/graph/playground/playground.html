<div class="playground-container">
  <!-- Panel latÃ©ral avec les nodes disponibles -->
  <app-node-panel></app-node-panel>

  <!-- Zone principale (playground + console) -->
  <div class="main-area">
  <div
    #playgroundArea
    class="playground-area"
    cdkDropList
    id="playground-area"
    [cdkDropListConnectedTo]="['node-panel-list']"
    (cdkDropListDropped)="onDrop($event)"
    (mousedown)="onPlaygroundMouseDown($event)"
    (mousemove)="onPlaygroundMouseMove($event)"
    (mouseup)="onPlaygroundMouseUp($event)"
    (click)="onPlaygroundClick($event)"
    [class.panning]="isPanning()"
  >

    @if (isLoadingJob()) {
      <div class="loading-overlay">
        <i class="pi pi-spin pi-spinner"></i>
        <span>Chargement du job...</span>
      </div>
    }

    <svg class="connections-layer">
      @for (connection of connections(); track connection.id) {
      <path
        [attr.d]="getConnectionPath(connection)"
        [class]="'connection connection-' + nodeGraph.getConnectionKind(connection)"
        fill="none"
        [attr.stroke]="nodeGraph.getConnectionKind(connection) === 'data' ? '#2196F3' : '#4CAF50'"
        stroke-width="3"
      />
      }

      @if (tempConnection(); as temp) {
      <path
        [attr.d]="nodeGraph.getTempConnectionPath(temp)"
        class="temp-connection"
        fill="none"
        stroke="#FF9800"
        stroke-width="3"
        stroke-dasharray="5,5"
      />
      }
    </svg>

    @for (node of nodes(); track node.id) {
    <div
      class="node-wrapper"
      [style.transform]="
        'translate(' +
        (node.position.x + panOffset().x) +
        'px, ' +
        (node.position.y + panOffset().y) +
        'px)'
      "
      (mousedown)="onNodeMouseDown($event, node.id)"
      (dblclick)="openNodeModal(node.id)"
    >
      <app-node-instance
        [node]="node"
        [panOffset]="panOffset()"
        [isPanning]="isPanning()"
        (outputPortClick)="onOutputPortClick($event)"
        (inputPortClick)="onInputPortClick($event)"
      ></app-node-instance>
    </div>
    }

    @if (activeModal(); as modal) {
    <div class="modal-overlay">
      <div class="modal-container">
        @if (modal.nodeTypeId === 'db-input' && nodeGraph.getNodeById(modal.nodeId); as node) {
        <app-db-input-modal
          [node]="node"
          (close)="closeModal()"
          (save)="onDbInputSave(modal.nodeId, $event)"
        ></app-db-input-modal>
        }
        @if (modal.nodeTypeId === 'start' && nodeGraph.getNodeById(modal.nodeId); as node) {
        <app-start-modal
          (close)="closeModal()"
        ></app-start-modal>
        }
        @if (modal.nodeTypeId === 'transform' && nodeGraph.getNodeById(modal.nodeId); as node) {
        <app-transform-modal
          (close)="closeModal()"
        ></app-transform-modal>
        }
      </div>
    </div>
    }

    <app-minimap
      [nodes]="nodes()"
      [viewportWidth]="viewportWidth()"
      [viewportHeight]="viewportHeight()"
      [panOffset]="panOffset()"
    ></app-minimap>
  </div>

  <!-- Bottom bar avec onglets Console/Config -->
  <app-playground-bottom-bar
    #bottomBar
    (onSave)="onJobSave()"
    (onExecute)="onJobExecute()"
    (onStop)="onJobStop()"
  ></app-playground-bottom-bar>
  </div>
</div>

