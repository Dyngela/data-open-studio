<div class="z-[max]">
  <div class="modal-header">
    <div>
      <h3>Database Input</h3>
      <p class="subtitle">Sélectionner une connexion et configurer la requête</p>
    </div>
    <button class="icon-btn" type="button" (click)="onCancel()">×</button>
  </div>

  <div class="modal-body" [formGroup]="form">

    <!-- Connection select -->
<!--    <label class="field">-->
<!--    <span class="field-label">-->
<!--      <i class="pi pi-link"></i>-->
<!--      Connexion-->
<!--    </span>-->
<!--      <select-->
<!--        [value]="form.controls.connectionId.value"-->
<!--        (change)="onConnectionSelected(+$any($event.target).value)"-->
<!--      >-->
<!--        <option [value]="null" disabled selected>Sélectionner une connexion</option>-->
<!--        @for (conn of connections(); track conn.id) {-->
<!--          <option [value]="conn.id">{{ conn.databaseName }} ({{ conn.host }}:{{ conn.port }})</option>-->
<!--        }-->
<!--      </select>-->
<!--    </label>-->
<!--    -->
    <kui-select
    [control]="form.controls.connectionId"
    [options]="connectionsOptions()"

    >

    </kui-select>

    <!-- Connection details card -->
    @if (selectedConnection(); as conn) {
      <div class="connection-details-card">
        <div class="connection-details-header">
          <i class="pi pi-check-circle" style="color: #4caf50;"></i>
          <span>Détails de la connexion</span>
        </div>

        <div class="connection-details-grid">
          <div class="detail-item">
            <span class="detail-label">Type:</span>
            <span class="detail-value">
            <i [class]="getConnectionDbIcon(conn)"></i>
            {{ conn.databaseType || '—' }}
          </span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Host:</span>
            <span class="detail-value">{{ conn.host || '—' }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Port:</span>
            <span class="detail-value">{{ conn.port || '—' }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Base de données:</span>
            <span class="detail-value">{{ conn.databaseName || '—' }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">Utilisateur:</span>
            <span class="detail-value">{{ conn.user || '—' }}</span>
          </div>

          <div class="detail-item">
            <span class="detail-label">SSL:</span>
            <span class="detail-value">
            <i [class]="conn.sslMode === 'require' ? 'pi pi-check-circle' : 'pi pi-times-circle'"
               [style.color]="conn.sslMode === 'require' ? '#4caf50' : '#ff6b6b'"></i>
              {{ conn.sslMode === 'require' ? 'Activé' : 'Désactivé' }}
          </span>
          </div>
        </div>
      </div>
    }

    <!-- SQL Query -->
    <label class="field">
    <span class="field-label">
      <i class="pi pi-code"></i>
      Requête SQL
      <button
        class="btn-icon"
        type="button"
        title="Deviner le schéma depuis la requête"
        (click)="guessSchema()"
        [disabled]="isGuessingSchema()"
      >
        @if (isGuessingSchema()) {
          <i class="pi pi-spin pi-spinner"></i>
          Analyse...
        } @else {
          <i class="pi pi-sparkles"></i>
          Trouver le schéma
        }
      </button>
    </span>
      <textarea
        rows="5"
        formControlName="query"
        placeholder="SELECT * FROM customers WHERE active = true;"
        class="code-input"
      ></textarea>
      <span class="field-hint">Optionnel : Laissez vide pour récupérer toutes les données</span>
    </label>

    <!-- Schema guess error -->
    @if (guessError()) {
      <div class="schema-error">
        <i class="pi pi-exclamation-triangle"></i>
        {{ guessError() }}
      </div>
    }

    <!-- Guessed schema results -->
    @if (guessedSchema().length > 0) {
      <div class="schema-results">
        <div class="schema-header">
          <i class="pi pi-check-circle" style="color: #4caf50;"></i>
          <span>Schéma détecté ({{ guessedSchema().length }} colonnes)</span>
        </div>
        <div class="schema-table">
          <table>
            <thead>
            <tr>
              <th>Colonne</th>
              <th>Type DB</th>
              <th>Type Go</th>
              <th>Nullable</th>
            </tr>
            </thead>
            <tbody>
              @for (col of guessedSchema(); track col.name) {
                <tr>
                  <td class="col-name">{{ col.name }}</td>
                  <td class="col-type">{{ col.type }}</td>
                  <td class="col-go-type">{{ col.goType }}</td>
                  <td class="col-nullable">
                    <i [class]="col.nullable ? 'pi pi-check' : 'pi pi-times'"
                       [style.color]="col.nullable ? '#4caf50' : '#888'"></i>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

  </div>

  <div class="modal-footer">
    <button class="btn secondary" type="button" (click)="onCancel()">Annuler</button>
    <button
      class="btn primary"
      type="button"
      (click)="onSave()"
      [disabled]="!selectedConnection()"
    >Enregistrer</button>
  </div>
</div>

