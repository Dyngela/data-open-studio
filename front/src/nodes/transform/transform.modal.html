<div class="h-max-content">
  <div class="modal-header">
    <div>
      <h3>Transformation</h3>
      <p class="subtitle">Configure les jointures et les colonnes de sortie</p>
    </div>
    <button class="icon-btn" type="button" (click)="onCancel()">×</button>
  </div>

  <div class="modal-body">

    @if (hasMultipleInputs()) {
      <div class="bg-[#1a1a1a] border-[1.5px] border-[#2a2a2a] rounded-lg overflow-hidden transition-all duration-300">

        <input type="checkbox" id="join-toggle" class="peer hidden" checked />

        <label
          for="join-toggle"
          class="flex items-center gap-2 px-4 py-3 bg-[#1f1f1f] border-b border-[#2a2a2a] font-semibold text-sm text-[#e0e0e0] cursor-pointer select-none"
        >
          <i class="pi pi-link text-[#ff9800]"></i>
          <span>Jointure</span>

          <div class="ml-auto text-[#6a6a6a] transition-transform duration-200 peer-checked:rotate-0 rotate-90">
            <span class="text-xl font-mono block peer-checked:hidden">+</span>
            <span class="text-xl font-mono hidden peer-checked:block">−</span>
          </div>
        </label>

        <div class="hidden peer-checked:block animate-in fade-in slide-in-from-top-1 duration-200">

          <div class="flex gap-2 p-3 border-b border-[#252525]">
            <button
              class="join-type-btn"
              [class.active]="joinType() === 'inner'"
              (click)="setJoinType('inner')"
            >
              <span class="join-type-icon">⊝</span>
              INNER
            </button>
            <button
              class="join-type-btn"
              [class.active]="joinType() === 'left'"
              (click)="setJoinType('left')"
            >
              <span class="join-type-icon">⊂</span>
              LEFT
            </button>
            <button
              class="join-type-btn"
              [class.active]="joinType() === 'right'"
              (click)="setJoinType('right')"
            >
              <span class="join-type-icon">⊃</span>
              RIGHT
            </button>
          </div>

          <div class="grid grid-cols-[1fr_auto_1fr] min-h-37.5">
            <!-- Left input -->
            @if (leftInput(); as left) {
              <div class="join-input-panel">
                <div class="join-input-header">
                  <span class="input-label">{{ left.name }}</span>
                  <span class="input-col-count">{{ left.schema.length }} col.</span>
                </div>
                <div class="join-column-list">
                  @for (col of left.schema; track col.name) {
                    <div
                      class="join-column-item"
                      [class.joined]="isJoinedCol(left.name, col.name)"
                      [class.drop-target]="isDropTarget(left.name, col.name)"
                      draggable="true"
                      (dragstart)="onDragStart($event, left.name, col)"
                      (dragover)="onDragOver($event, left.name, col.name)"
                      (dragleave)="onDragLeave()"
                      (drop)="onDrop($event, left.name, col)"
                      (dragend)="onDragEnd()"
                    >
                      <i class="pi pi-arrows-alt drag-handle"></i>
                      <span class="col-name">{{ col.name }}</span>
                      <span class="col-type">{{ col.type }}</span>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Join keys visualization -->
            <div class="join-keys-column">
              @if (joinKeys().length === 0) {
                <div class="join-keys-hint">
                  <i class="pi pi-arrow-right-arrow-left"></i>
                  <span>Glissez une colonne vers l'autre table</span>
                </div>
              } @else {
                @for (pair of joinKeys(); track $index; let i = $index) {
                  <div class="join-key-pair">
                    <span class="key-col left-key">{{ pair.leftCol }}</span>
                    <span class="key-eq">=</span>
                    <span class="key-col right-key">{{ pair.rightCol }}</span>
                    <button class="btn-sm btn-remove" (click)="removeJoinKey(i)" title="Retirer">
                      <i class="pi pi-times"></i>
                    </button>
                  </div>
                }
              }
            </div>

            <!-- Right input -->
            @if (rightInput(); as right) {
              <div class="join-input-panel">
                <div class="join-input-header">
                  <span class="input-label">{{ right.name }}</span>
                  <span class="input-col-count">{{ right.schema.length }} col.</span>
                </div>
                <div class="join-column-list">
                  @for (col of right.schema; track col.name) {
                    <div
                      class="join-column-item"
                      [class.joined]="isJoinedCol(right.name, col.name)"
                      [class.drop-target]="isDropTarget(right.name, col.name)"
                      draggable="true"
                      (dragstart)="onDragStart($event, right.name, col)"
                      (dragover)="onDragOver($event, right.name, col.name)"
                      (dragleave)="onDragLeave()"
                      (drop)="onDrop($event, right.name, col)"
                      (dragend)="onDragEnd()"
                    >
                      <i class="pi pi-arrows-alt drag-handle"></i>
                      <span class="col-name">{{ col.name }}</span>
                      <span class="col-type">{{ col.type }}</span>
                    </div>
                  }
                </div>
              </div>
            }

          </div>
        </div>
      </div>
    }

    <!-- Mapping Section: Inputs (left) → Output (right) -->
    <div class="grid grid-cols-3 gap-4 min-h-[200px]">

      <!-- Left: Input panels stacked vertically -->
      <div class="bg-[#1a1a1a] border-[1.5px] border-[#2a2a2a] rounded-lg">
        <div class="section-header">
          <i class="pi pi-sign-in"></i>
          <span>Entrees</span>
        </div>

        @if (upstreamInputs().length === 0) {
          <div class="empty-state">
            <i class="pi pi-info-circle"></i>
            <span>Aucune entree connectee</span>
          </div>
        }

        <div class="inputs-scroll">
          @for (inp of upstreamInputs(); track inp.name) {
            <div class="input-group">
              <div class="input-group-header">
                <span class="input-label">{{ inp.name }}</span>
                <span class="input-col-count">{{ inp.schema.length }} col.</span>
                <button class="btn-add-all" (click)="addAllColumns(inp.name, inp.schema)" title="Tout ajouter">
                  <i class="pi pi-plus"></i> Tout
                </button>
              </div>
              <div class="input-column-list">
                @for (col of inp.schema; track col.name) {
                  <div
                    class="input-column-item"
                    draggable="true"
                    (dragstart)="onDragStart($event, inp.name, col)"
                    (dragend)="onDragEnd()"
                    (click)="addColumn(inp.name, col)"
                    title="Glissez vers la sortie ou cliquez pour ajouter"
                  >
                    <i class="pi pi-arrows-alt drag-handle"></i>
                    <span class="col-name">{{ col.name }}</span>
                    <span class="col-type">{{ col.type }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>

      <div class="bg-[#1a1a1a] border-[1.5px] border-[#2a2a2a] rounded-lg">
        <app-map-global-filter></app-map-global-filter>
      </div>

      <!-- Right: Output columns -->
      <div
        class="bg-[#1a1a1a] border-[1.5px] border-[#2a2a2a] rounded-lg"
        (dragover)="onOutputPanelDragOver($event)"
        (dragleave)="onOutputPanelDragLeave($event)"
        (drop)="onOutputPanelDrop($event)"
      >
        <div class="section-header">
          <i class="pi pi-sign-out"></i>
          <span>Colonnes de sortie</span>
          <span class="col-count-badge">{{ outputColumns().length }}</span>
        </div>

        @if (downstreamSchema().length) {
          <div class="output-toolbar">
            <button class="btn-action" (click)="fillFromDownstream()" title="Charger le schema de la cible sans associer">
              <i class="pi pi-download"></i> Schema cible
            </button>
            <button class="btn-action btn-action-match" (click)="autoMatchColumns()" title="Associer automatiquement par nom de colonne">
              <i class="pi pi-bolt"></i> Auto-match
            </button>
          </div>
        }

        @if (outputColumns().length === 0) {
          <div class="empty-state drop-zone" [class.drop-hover]="outputPanelHovered()">
            <i class="pi pi-arrow-left"></i>
            <span>Glissez des colonnes ici</span>
          </div>
        } @else {
          <div class="output-list">
            @for (col of outputColumns(); track $index; let i = $index) {
              <app-map-output-field
                class="output-item"
                [class.drop-target]="dropTargetOutputIndex() === i"
                [class.unmapped]="!col.inputRef"
                (dragover)="onOutputItemDragOver($event, i)"
                (dragleave)="onOutputItemDragLeave()"
                (drop)="onOutputItemDrop($event, i)"

                [column]="col"
                [index]="i"
                [columns]="outputColumns"
              ></app-map-output-field>

            }
          </div>
        }
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button class="btn secondary" type="button" (click)="onCancel()">Annuler</button>
    <button class="btn primary" type="button" (click)="onSave()">Enregistrer</button>
  </div>

</div>
