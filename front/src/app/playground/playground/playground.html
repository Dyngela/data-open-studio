<div class="playground-container">
  <!-- Panel latéral avec les nodes disponibles -->
  <app-node-panel></app-node-panel>

  <!-- Zone principale du playground -->
  <div
    #playgroundArea
    class="playground-area"
    cdkDropList
    cdkDropListSortingDisabled
    id="playground-area"
    [cdkDropListConnectedTo]="['node-panel-list']"
    (cdkDropListDropped)="onDrop($event)"
    (mousedown)="onPlaygroundMouseDown($event)"
    (mousemove)="onPlaygroundMouseMove($event)"
    (mouseup)="onPlaygroundMouseUp($event)"
    (click)="onPlaygroundClick($event)"
    [class.panning]="isPanning()"
  >
    <div class="toolbar">
      <button class="toolbar-btn" (click)="saveSchema()" title="Sauvegarder le schéma">
        <i class="fas fa-save"></i>
        <span>Sauvegarder</span>
      </button>
      <button class="toolbar-btn" (click)="loadSchema()" title="Charger un schéma">
        <i class="fas fa-folder-open"></i>
        <span>Charger</span>
      </button>
      <button class="toolbar-btn toolbar-btn-danger" (click)="clearSchema()" title="Effacer tout">
        <i class="fas fa-trash"></i>
        <span>Effacer</span>
      </button>
    </div>

    <input
      #fileInput
      type="file"
      accept=".json"
      style="display: none;"
      (change)="onFileSelected($event)"
    />
    <svg class="connections-layer">
      @for (connection of connections(); track connection.id) {
      <path
        [attr.d]="getConnectionPath(connection)"
        [class]="'connection connection-' + getConnectionKind(connection)"
        fill="none"
        [attr.stroke]="getConnectionKind(connection) === 'data' ? '#2196F3' : '#4CAF50'"
        stroke-width="3"
      />
      }

      @if (tempConnection(); as temp) {
      <path
        [attr.d]="getTempConnectionPath()"
        class="temp-connection"
        fill="none"
        stroke="#FF9800"
        stroke-width="3"
        stroke-dasharray="5,5"
      />
      }
    </svg>

    @for (node of nodes(); track node.id) {
    <div
      class="node-wrapper"
      [style.transform]="
        'translate(' +
        (node.position.x + panOffset().x) +
        'px, ' +
        (node.position.y + panOffset().y) +
        'px)'
      "
      (mousedown)="onNodeMouseDown($event, node.id)"
      (dblclick)="openNodeModal(node.id)"
    >
      <app-node-instance
        [node]="node"
        [panOffset]="panOffset()"
        [isPanning]="isPanning()"
        (outputPortClick)="onOutputPortClick($event)"
        (inputPortClick)="onInputPortClick($event)"
      ></app-node-instance>
    </div>
    }

    @if (activeModal(); as modal) {
    <div class="modal-overlay">
      <div class="modal-container">
        @if (modal.nodeTypeId === 'db-input' && getNodeById(modal.nodeId); as node) {
        <app-db-input-modal
          [node]="node"
          (close)="closeModal()"
          (save)="onDbInputSave(modal.nodeId, $event)"
        ></app-db-input-modal>
        }
        @if (modal.nodeTypeId === 'start' && getNodeById(modal.nodeId); as node) {
        <app-start-modal
          (close)="closeModal()"
        ></app-start-modal>
        }
        @if (modal.nodeTypeId === 'transform' && getNodeById(modal.nodeId); as node) {
        <app-transform-modal
          (close)="closeModal()"
        ></app-transform-modal>
        }
      </div>
    </div>
    }

    <app-minimap
      [nodes]="nodes()"
      [viewportWidth]="viewportWidth()"
      [viewportHeight]="viewportHeight()"
      [panOffset]="panOffset()"
    ></app-minimap>
  </div>
</div>

